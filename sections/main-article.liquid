{{ 'blog.css' | asset_url | stylesheet_tag }}
{{ 'article.css' | asset_url | stylesheet_tag }}
{% comment %}
  {% render 'subscription-popup', popup: section.settings %}
{% endcomment %}

<style>
  /* 1. The styling for the Disclaimer Paragraph */
  .js-disclaimer-truncate {
    display: -webkit-box !important; /* Forces flex-box layout needed for clamping */
    -webkit-line-clamp: 3 !important; /* Limits to exactly 3 lines */
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
    position: relative;
    margin-bottom: 0px; /* Removes bottom margin so button sits close */
    transition: all 0.3s ease;
  }

  /* 2. When the button is clicked, this class is added to show full text */
  .js-disclaimer-truncate.expanded {
    -webkit-line-clamp: unset !important; /* Removes the limit */
    display: block !important; /* Returns to normal block display */
    overflow: visible !important;
  }

  /* 3. The 'Read More' Button styling */
  .disclaimer-btn {
    background: transparent;
    border: none;
    padding: 0;
    margin-top: 0px;
    margin-bottom: 20px;
    color: #00e; /* Your theme's teal color */
    font-weight: 500;
    text-decoration: underline;
    cursor: pointer;
    font-size: 20px;
    display: inline-block;
    line-height: 1.5;
  }

  .disclaimer-btn:hover {
    color: #000;
    text-decoration: none;
  }

  .template--article .article__content :is(li, a, p) {
    margin-bottom: 0px;
  }

  @media screen and (max-width: 768px) {
    .disclaimer-btn {
      font-size: 14px;
    }
  }
</style>

<article class="main-article js-article">
  {%- if section.settings.pagination != 'none' -%}
    {%- if section.settings.pagination != 'standard' -%}
      {{ 'article-pagination.css' | asset_url | stylesheet_tag }}
      <script src="{{ 'article-pagination.js' | asset_url }}" defer="defer"></script>
    {%- endif -%}

    <article-pagination
      class="article__pagination pagination__bar flex justify-between font-bold border-top{% if section.settings.pagination == "standard" %} border-bottom reading-width article-width mx-auto mt-12 lg:blog-mt-16{% else %} bottom-0 left-0 w-full pl-4 pr-4{% endif %}"
    >
    </article-pagination>
  {%- endif -%}
  <div class="article--banner">
    <div class="container">
      <div class="article-banner-content">
        {% if article.metafields.custom.post_category != blank %}
          {% for category in article.metafields.custom.post_category.value %}
            <span class="article-tag">{{ category }}</span>
            {% unless forloop.last %},{% endunless %}
          {% endfor %}
        {% endif %}

        <h1 class="mb-0">{{ article.title | escape }}</h1>
        <article-pagination>
          <span
            class="read-time article__pagination--text js-pagination-text no-js-hidden"
            data-show-reading-time="true"
          ></span>
        </article-pagination>
        <div class="artilce-info-wrapper">
          {%- if section.settings.show_author or section.settings.show_date -%}
            {%- if section.settings.show_author -%}
              <div class="article-writer">
                {% if article.metafields.custom.writer_profile != blank %}
                  <img
                    src="{{ article.metafields.custom.writer_profile.value | img_url:'master' }}"
                    alt="Profile Picture"
                  >
                {% else %}
                  <img
                    src="https://cdn.shopify.com/s/files/1/0720/7695/1854/files/profile-placeholder.jpg?v=1724683766"
                    alt="Profile Placeholder"
                  >
                {% endif %}

                <p>
                  Written By: <span>{{ article.author -}}</span>
                </p>
              </div>
            {% endif %}
            <div class="publish-date">
              <p>
                {%- if section.settings.show_date -%}
                  Published:
                  <span>{{ article.published_at | time_tag: format: 'date' }}</span>
                {%- endif -%}
              </p>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>

  <div class="article-body">
    <div class="container">
      {%- if section.settings.show_tags -%}
        {%- capture tag_markup -%}
        <div class="article__tags mb-4 lg:blog-mb-6 last:mb-0 reading-width mx-auto uppercase {{ section.settings.heading_align }}">
          {%- for tag in article.tags -%}
            <a href="{{ tag | link_to_tag: tag | split: 'href="' | last | split: '"' | first }}" class="text-theme-light text-sm">
              {{ tag }}{% unless forloop.last %}, {% endunless %}
            </a>
          {%- endfor -%}
        </div>
      {%- endcapture -%}
        {% if tag_markup contains '</a>' %}{{ tag_markup }}{% endif %}
      {%- endif -%}

      <div class="main-article-row {% if section.settings.sidebar_content == blank %}no-leftBarr{% endif %}">
        <div class="article-left-sidebar">
          <div class="blog-sidebar-filter sidebar-content">
            {% render 'article-list', sidebar_content: true %}
          </div>
        </div>
        <div class="article__content rte ">
          <div class="main-article-content">
            {{ article.content }}

            <div class="back-to-blog">
              <a href="{{ blog.url }}" class="btn btn--secondary">
                {%- render 'icon-article-arrow' %} Return to Blog Page</a
              >
            </div>
          </div>

          {% if section.blocks.size > 0 %}
            {% for promotion in section.blocks %}
              <div class="blog-wide-promotion">
                <div
                  class="bw-promotion-inner"
                  {% if promotion.settings.banner_image != blank %}
                    style="background-image:url({{ promotion.settings.banner_image | img_url:'master' }})"
                  {% endif %}
                >
                  <div class="bw-promotion-content">
                    <h2>{{ promotion.settings.heading }}</h2>

                    {% if promotion.settings.btn_label != blank %}
                      <a class="btn btn--secondary" href="{{ promotion.settings.btn_link }}">
                        {{- promotion.settings.btn_label -}}
                      </a>
                    {% endif %}
                    {{ promotion.settings.content }}
                  </div>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>
        <div class="article-right-sidebar">
          <div class="article-info">
            {% if article.metafields.custom.writer_profile != blank %}
              <img
                src="{{ article.metafields.custom.writer_profile.value | img_url:'master' }}"
                alt="Profile Picture"
              >
            {% else %}
              <img
                src="https://cdn.shopify.com/s/files/1/0720/7695/1854/files/profile-placeholder.png?v=1724684028"
                alt="Profile Placeholder"
              >
            {% endif %}

            <p class="author-name">{{ article.author -}}</p>
            {% if section.settings.writer_detail != blank %}
              <div class="author-detail">
                {{ section.settings.writer_detail }}
              </div>
            {% endif %}
            {% if section.settings.show_newsletter %}
              <div class="sidebar-newsletter-form">
                <h3>{{ section.settings.nl_heading }}</h3>
                {% render 'newsletter-signup', id: 'footer-signup', tags: 'newsletter', combined: false %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      {%- if section.settings.show_share_buttons -%}
        <div class="social-share reading-width article-width mx-auto flex items-center mt-12 lg:blog-mt-16">
          <p class="social-share__heading mb-0 font-bold">{{ 'general.social.share_heading' | t }}:</p>
          {% render 'social-share', share_title: article.title, share_url: article.url, share_image: article.image %}
        </div>
      {%- endif -%}
    </div>
  </div>
</article>

<script>
  document.querySelectorAll('.article__content table').forEach((table) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'scrollable-table';
    table.parentNode.insertBefore(wrapper, table);
    wrapper.appendChild(table);
  });
</script>

{% render 'structured-data-article', article: article %}

<script>
  const headings = document.querySelectorAll('.main-article-content h2');
  if (headings.length > 0) {
    const ul = document.querySelector('.content-list');
    if (ul) {
      headings.forEach((heading, index) => {
        const li = document.createElement('li');
        li.textContent = heading.textContent;
        li.addEventListener('click', function () {
          heading.scrollIntoView({ behavior: 'smooth' });
        });
        ul.appendChild(li);
      });
    }
  } else {
    const sidebar = document.querySelector('.sidebar-content');
    if (sidebar) sidebar.style.display = 'none';
  }
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const mainArticleContent = document.querySelector('.main-article-content');
    const blogPromotion = document.querySelector('.blog-wide-promotion');
    const backToBlog = document.querySelector('.back-to-blog');

    if (mainArticleContent && blogPromotion) {
      const h2Elements = mainArticleContent.querySelectorAll('h2');
      if (h2Elements.length >= 2) {
        const secondH2 = h2Elements[1];
        mainArticleContent.insertBefore(blogPromotion, secondH2);
      } else {
        mainArticleContent.insertBefore(blogPromotion, backToBlog);
      }
    }
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 1. Target the correct container
    const articleContainer =
      document.querySelector('.article__content') || document.querySelector('.main-article-content');
    if (!articleContainer) return;

    // 2. Prevent duplicate execution (guards against multiple script loads)
    if (articleContainer.dataset.disclaimerProcessed) return;
    articleContainer.dataset.disclaimerProcessed = 'true';

    // 3. Scan elements for "Disclaimer"
    const allElements = articleContainer.querySelectorAll('p, h3, h4, h5, strong, b');
    let targetParagraph = null;

    for (let el of allElements) {
      const textContent = el.textContent.trim().toLowerCase();

      // Check if this element contains "disclaimer"
      if (textContent.includes('disclaimer')) {
        // SCENARIO A: The element is a P with substantial content (more than just the word "disclaimer")
        if (el.tagName === 'P' && textContent.length > 50) {
          targetParagraph = el;
          break;
        }

        // SCENARIO B: The element is a P but only contains "disclaimer:" label
        // Look for the next paragraph which should contain the actual content
        if (el.tagName === 'P' && textContent.length <= 50) {
          let next = el.nextElementSibling;
          // Skip any existing buttons that might have been injected previously
          while (next && (next.tagName === 'BUTTON' || next.classList.contains('disclaimer-btn'))) {
            next = next.nextElementSibling;
          }
          if (next && next.tagName === 'P') {
            targetParagraph = next;
            break;
          }
        }

        // SCENARIO C: The element is inside a P (bold/strong tag)
        if (el.closest('p')) {
          const parentP = el.closest('p');
          const parentText = parentP.textContent.trim();

          // If parent P has substantial content, use it
          if (parentText.length > 50) {
            targetParagraph = parentP;
            break;
          }

          // Otherwise, the actual disclaimer content is likely in the next P
          let next = parentP.nextElementSibling;
          while (next && (next.tagName === 'BUTTON' || next.classList.contains('disclaimer-btn'))) {
            next = next.nextElementSibling;
          }
          if (next && next.tagName === 'P') {
            targetParagraph = next;
            break;
          }
        }

        // SCENARIO D: The element is a Header (h3, h4, etc.)
        if (['H1', 'H2', 'H3', 'H4', 'H5'].includes(el.tagName)) {
          let next = el.nextElementSibling;
          while (next && next.tagName !== 'P') {
            next = next.nextElementSibling;
            if (!next) break;
          }
          if (next) {
            targetParagraph = next;
            break;
          }
        }
      }
    }

    // 4. Apply changes if we found the content paragraph
    if (targetParagraph && !targetParagraph.classList.contains('js-disclaimer-truncate')) {
      targetParagraph.classList.add('js-disclaimer-truncate');

      const btn = document.createElement('button');
      btn.innerHTML = 'Read More';
      btn.className = 'disclaimer-btn';
      btn.type = 'button';

      // Use insertAdjacentElement for safe DOM insertion (avoids insertBefore errors)
      targetParagraph.insertAdjacentElement('afterend', btn);

      btn.addEventListener('click', function (e) {
        e.preventDefault();
        const isExpanded = targetParagraph.classList.contains('expanded');

        if (isExpanded) {
          targetParagraph.classList.remove('expanded');
          btn.innerHTML = 'Read More';
        } else {
          targetParagraph.classList.add('expanded');
          btn.innerHTML = 'Read Less';
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Article",
  "class": "cc-main-article section section--template",
  "settings": [
    {
      "type": "header",
      "content": "Article header"
    },
    {
      "type": "checkbox",
      "id": "show_tags",
      "label": "Show tags",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_author",
      "label": "Show author",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_date",
      "label": "Show published date",
      "default": true
    },
    {
      "type": "header",
      "content": "Article Sidebars"
    },
    {
      "type": "header",
      "content": "Left Sidebar"
    },
    {
      "type": "header",
      "content": "Right Sidebar",
      "info": "Writer Detail"
    },
    {
      "type": "richtext",
      "id": "writer_detail",
      "label": "Writer Detail"
    },
    {
      "type": "header",
      "content": "Newsletter Form"
    },
    {
      "type": "checkbox",
      "id": "show_newsletter",
      "label": "Show Newsletter",
      "default": true
    },
    {
      "type": "text",
      "id": "nl_heading",
      "label": "Newsletter Heading"
    },

    {
      "type": "header",
      "content": "Article footer"
    },
    {
      "type": "checkbox",
      "id": "show_share_buttons",
      "label": "Show social share links",
      "default": true
    },
    {
      "type": "select",
      "id": "pagination",
      "label": "Next/previous links",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "standard",
          "label": "Standard"
        },
        {
          "value": "bar",
          "label": "Fixed bar"
        },
        {
          "value": "bar-reading",
          "label": "Fixed bar with reading estimate"
        }
      ],
      "default": "standard"
    },
    {
      "type": "header",
      "content": "Popup Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "Content"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "foem_button_label",
      "label": "Form Button Label"
    }
  ],
  "blocks": [
    {
      "type": "promotion_banner",
      "name": "Promotion Banner",
      "settings": [
        {
          "type": "header",
          "content": "Article Promotion Banner"
        },
        {
          "type": "image_picker",
          "id": "banner_image",
          "label": "Banner Image"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content"
        },
        {
          "type": "text",
          "id": "btn_label",
          "label": "Button Label"
        },
        {
          "type": "url",
          "id": "btn_link",
          "label": "Button Label"
        }
      ]
    }
  ]
}
{% endschema %}
