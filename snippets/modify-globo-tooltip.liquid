{% assign variant_metafields_string = '' %}
{% for product in collections['uncategorized'].products %}
  {% for variant in product.variants %}
    {% if variant.metafields.global.description != blank %}
      {% assign variant_metafields_string = variant_metafields_string
        | append: variant.id
        | append: '<delimiter_first>'
        | append: variant.metafields.global.description
        | append: '<delimiter_second>'
      %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% assign variant_real_price_string = '' %}
{% for product in collections['uncategorized'].products %}
  {% for variant in product.variants %}
    {% if variant.metafields.custom.real_price != blank %}
      {% assign variant_real_price_string = variant_real_price_string
        | append: variant.id
        | append: '<delimiter_first>'
        | append: variant.metafields.custom.real_price
        | append: '<delimiter_second>'
      %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% style %}
  /* Hide original Globo tooltips, swatch images, and labels (we render cards) */
  .gpo-tooltip.zoom-image,
  .gpo-swatch__image,
  .gpo-ov-item label { display: none !important; }

  /* Also hide the original GPO items (keep in DOM for data scraping) */
  .gpo-swatches.image-swatches.gpo-ov-item { display: none; }

  /* Card styles - simplified to match target */
  .custom-variant-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 0;
    background: #fff;
    cursor: pointer;
    transition: all .2s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
    width: 100%;
  }
  .custom-variant-card:hover { 
    border-color: #d1d5db; 
    box-shadow: 0 1px 2px rgba(0,0,0,.05); 
  }
  .custom-variant-card.selected { 
    border-color: #16a085; 
    border-width: 2px; 
    padding: 15px; 
    background: #f0fdf9; 
  }

  .card-image-container {
    flex-shrink: 0; 
    width: 64px; 
    height: 64px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    background: #f9fafb; 
    border-radius: 6px; 
    overflow: hidden;
  }
  .card-image { 
    max-width: 100%; 
    max-height: 100%; 
    object-fit: contain; 
  }

  .card-content { 
    flex: 1; 
    min-width: 0; 
  }
  .card-title { 
    font-size: 15px; 
    font-weight: 600; 
    margin: 0 0 6px; 
    color: #111827; 
    line-height: 1.4; 
  }

  .card-price-section { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    flex-wrap: wrap; 
    margin-top: 4px; 
  }
  .card-price-current { 
    font-size: 15px; 
    font-weight: 700; 
    color: #111827; 
  }
  .card-save-badge { 
    background: #16a085; 
    color: #fff; 
    padding: 3px 8px; 
    border-radius: 3px; 
    font-size: 10px; 
    font-weight: 700; 
    text-transform: uppercase; 
  }
  .card-price-was { 
    font-size: 13px; 
    color: #ef4444;
    text-decoration: line-through; 
    font-weight: 500;
  }
  .card-free-badge { 
    color: #16a085; 
    font-size: 13px; 
    font-weight: 600; 
  }

  input[gpo-data-variant-id] { 
    position: absolute; 
    opacity: 0; 
    pointer-events: none; 
  }

  @media (max-width:768px){
    .custom-variant-card { 
      flex-direction: row; 
      text-align: left; 
    }
    .card-image-container { 
      width: 56px; 
      height: 56px; 
    }
    .card-title { 
      font-size: 14px; 
    }
    .card-price-current { 
      font-size: 15px; 
    }
  }

  /* Freebies visual tweak */
  .freebies .custom-variant-card { 
    background: #f5f5f5; 
    border-color: #000; 
  }

  /* Layout: default 2 columns for groups, 1 col on mobile */
  .gpo-element .gpo-ov-wrapper.horizontal {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0,1fr)) !important;
    gap: 0px !important;
  }
  @media (max-width:768px){
    .gpo-element .gpo-ov-wrapper.horizontal { 
      grid-template-columns: 1fr !important; 
    }
  }
  /* Only Wood Type & Heater Size become full-width */
  .gpo-element.fullwidth .gpo-ov-wrapper.horizontal { 
    grid-template-columns: 1fr !important; 
  }

  /* Tier headers - each card gets its own header */
  .gpo-help-header {
    font-weight: 700;
    font-size: 13px;
    letter-spacing: 0.5px;
    padding: 10px 16px;
    border-radius: 6px 6px 0 0;
    margin: 16px 0 0 0;
    color: #fff;
    text-align: center;
    text-transform: uppercase;
    grid-column: 1 / -1;
  }
  .gpo-help-starters { background: #0f766e; }
  .gpo-help-best     { background: #0ea5e9; }
  .gpo-help-pros     { background: #111827; }

  /* Card directly after header connects to it */
  .gpo-help-header + .custom-variant-card {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0;
    margin-bottom: 16px;
  }

  /* First header in the wrapper has no top margin */
  .gpo-ov-wrapper.horizontal > .gpo-help-header:first-child {
    margin-top: 0;
  }
{% endstyle %}

<script>
  /* === Build cards from GPO tooltips (kept as-is, minor safety tweaks) === */
  const vmsString = {{ variant_metafields_string | default: '' | json }};
  const vrpString = {{ variant_real_price_string | default: '' | json }};

  const vmMap = new Map();
  const vrpMap = new Map();
  const processedCards = new Set();
  const inputCache = new Map();

  if (vrpString) {
    vrpString.split("<delimiter_second>").forEach((segment) => {
      const [id, price] = segment.split("<delimiter_first>");
      if (id && price) vrpMap.set(id, price);
    });
  }
  if (vmsString) {
    vmsString.split("<delimiter_second>").forEach((segment) => {
      const [id, description] = segment.split("<delimiter_first>");
      if (id && description) vmMap.set(id, description);
    });
  }

  function getCachedInput(variantId){
    if (inputCache.has(variantId)) return inputCache.get(variantId);
    const input = document.querySelector(`input[gpo-data-variant-id="${variantId}"]`);
    if (input) inputCache.set(variantId, input);
    return input;
  }

  function getImageUrl(input){
    if (!input || !input.nextElementSibling) return '';
    const container = input.nextElementSibling;

    let img = container.querySelector('.gpo-swatch__inner .swatch-image');
    if (img?.src) return img.src;

    img = container.querySelector('.gpo-swatch__image');
    if (img) return img.src || img.getAttribute('data-src') || '';

    img = container.querySelector('.gpo-tooltip__image img');
    if (img) return img.src || img.getAttribute('data-src') || '';

    img = container.querySelector('img');
    if (img) return img.src || img.getAttribute('data-src') || '';

    const label = container.querySelector('label');
    if (label){
      img = label.querySelector('img');
      if (img) return img.src || img.getAttribute('data-src') || '';
    }

    const withBg = container.querySelectorAll('[style*="background-image"]');
    for (const el of withBg){
      const m = (el.style.backgroundImage || '').match(/url\(['"]?(.*?)['"]?\)/);
      if (m?.[1]) return m[1];
    }
    return '';
  }

  function buildVariantCards(){
    const inputs = document.querySelectorAll('input[gpo-data-variant-id]');
    if (!inputs.length) return;

    inputCache.clear();
    const variantIds = new Set();
    inputs.forEach(i => {
      const id = i.getAttribute('gpo-data-variant-id');
      if (id) variantIds.add(id);
    });

    let cardsCreated = 0;

    variantIds.forEach((variantId) => {
      if (processedCards.has(variantId)) return;

      const input = getCachedInput(variantId);
      if (!input) return;

      const tooltipParent = input.nextElementSibling?.querySelector('div.gpo-tooltip');
      if (!tooltipParent) return;

      const childDivs = tooltipParent.querySelectorAll('div');
      if (!childDivs.length) return;

      let productName = '';
      let priceHTML = '';
      const imageUrl = getImageUrl(input);

      for (let i=0; i<childDivs.length; i++){
        if (childDivs[i].classList.contains('gpo-tooltip__title')) {
          const titleClone = childDivs[i].cloneNode(true);
          const addOn = titleClone.querySelector('.addOn');

          if (addOn) {
            const value = addOn.textContent.trim();
            const match = value.match(/[\d,]+/);
            addOn.remove();
            productName = titleClone.textContent.trim();

            if (match){
              const valNum = match[0].replace(/,/g, '');
              if (valNum && valNum !== '0') {
                const currentPrice = parseInt(valNum, 10);
                const currentPriceFormatted = `$${currentPrice.toLocaleString('en-US')}`;

                if (vrpMap.has(variantId)) {
                  const realPriceNum = parseInt(vrpMap.get(variantId), 10);
                  const savings = realPriceNum - currentPrice;
                  priceHTML = `
                    <div class="card-price-section">
                      <span class="card-price-current">${currentPriceFormatted}</span>
                      <span class="card-save-badge">Save $${savings.toLocaleString('en-US')}</span>
                      <span class="card-price-was">$${realPriceNum.toLocaleString('en-US')} USD</span>
                    </div>`;
                } else {
                  priceHTML = `
                    <div class="card-price-section">
                      <span class="card-price-current">${currentPriceFormatted}</span>
                    </div>`;
                }
              } else {
                priceHTML = '<div class="card-free-badge">FREE - Included with your order</div>';
              }
            } else {
              priceHTML = '<div class="card-free-badge">FREE - Included with your order</div>';
            }
          } else {
            productName = childDivs[i].textContent.trim();
            priceHTML = '<div class="card-free-badge">FREE - Included with your order</div>';
          }
          break;
        }
      }

      if (!productName) return;

      const card = document.createElement('div');
      card.className = 'custom-variant-card';
      card.setAttribute('data-variant-id', variantId);
      card.innerHTML = `
        ${imageUrl ? `<div class="card-image-container"><img src="${imageUrl}" alt="${productName}" class="card-image"></div>` : ``}
        <div class="card-content">
          <h3 class="card-title">${productName}</h3>
          ${priceHTML}
        </div>`;

      card.addEventListener('click', (e) => {
        e.preventDefault();

        const inFreebies = input.closest('.freebies') !== null;
        if (inFreebies) return;

        if (input.type === 'checkbox') {
          input.checked = !input.checked;
        } else if (input.type === 'radio') {
          const siblings = document.querySelectorAll(`input[type="radio"][name="${input.name}"][gpo-data-variant-id]`);
          if (siblings.length === 1 && input.checked) input.checked = false;
          else input.checked = true;
        }

        input.dispatchEvent(new Event('change', { bubbles:true }));

        const groupInputs = document.querySelectorAll(`input[name="${input.name}"]`);
        groupInputs.forEach(inp => {
          const vId = inp.getAttribute('gpo-data-variant-id');
          const c = document.querySelector(`.custom-variant-card[data-variant-id="${vId}"]`);
          if (c) c.classList.toggle('selected', !!inp.checked);
        });
      });

      const ovItem = input.closest('.gpo-ov-item');
      if (ovItem?.parentElement) {
        ovItem.parentElement.insertBefore(card, ovItem);
        processedCards.add(variantId);
        cardsCreated++;
      }

      if (input.checked) card.classList.add('selected');
    });

    if (cardsCreated > 0) console.log(`âœ… Created ${cardsCreated} cards`);
  }

  let freebiesStyled = false;
  function styleFreebies(){
    if (freebiesStyled) return;
    const freebiesElement = document.querySelector('.freebies');
    if (!freebiesElement) return;
    freebiesElement.querySelectorAll('.gpo-ov-item').forEach((val) => {
      val.style.background = '#f5f5f5';
      const label = val.querySelector('label');
      if (label) label.style.borderColor = '#000';
    });
    freebiesStyled = true;
  }

  function addAltTextToImages(){
    document.querySelectorAll('.gpo-swatch__image img, .gpo-tooltip__image img, .card-image')
      .forEach((img) => { if (!img.hasAttribute('alt')) img.setAttribute('alt','Product Image'); });
  }

  function initialize(){
    // wait at least once for GPO internals, then build
    let tried = 0, maxTries = 1;
    const t = setInterval(() => {
      tried++;
      const addOns = document.querySelectorAll('.addOn');
      const swatchImages = document.querySelectorAll('.swatch-image');
      if (addOns.length > 0 && swatchImages.length > 0) {
        clearInterval(t);
        buildVariantCards(); styleFreebies(); addAltTextToImages();
      } else if (tried >= maxTries) {
        clearInterval(t);
        buildVariantCards(); styleFreebies(); addAltTextToImages();
      }
    }, 100);
  }

  let mutationTimeout;
  function handleMutations(){
    clearTimeout(mutationTimeout);
    mutationTimeout = setTimeout(() => {
      buildVariantCards(); styleFreebies(); addAltTextToImages();
    }, 150);
  }

  document.addEventListener('DOMContentLoaded', function(){
    initialize();
    const observer = new MutationObserver((mutations) => {
      let shouldUpdate = false;
      for (const m of mutations){
        for (const n of m.addedNodes){
          if (n.nodeType === 1){
            if (n.classList?.contains('gpo-swatches') ||
                n.querySelector?.('.gpo-swatches') ||
                n.classList?.contains('addOn') ||
                n.querySelector?.('.swatch-image')) { shouldUpdate = true; break; }
          }
        }
        if (shouldUpdate) break;
      }
      if (shouldUpdate) handleMutations();
    });
    const gpoContainer = document.querySelector('.gpo-element') || document.body;
    observer.observe(gpoContainer, { childList:true, subtree:true });
  });
</script>

<script>
  /* === Full-width groups + Tier headers/badges (uses .gpo-ov-helptext) === */
  (function(){
    // TEMP: map "test" â†’ Best Value so you can see it without changing GPO admin
    function tierFrom(text){
      const t = (text || '').toLowerCase().trim();
      if (t.includes('test'))   return { key:'best',     header:'BEST VALUE!',  headerClass:'gpo-help-best',     badgeClass:'gpo-badge-best' };
      if (t.includes('starter'))return { key:'starters', header:'FOR STARTERS', headerClass:'gpo-help-starters', badgeClass:'gpo-badge-starters' };
      if (t.includes('best'))   return { key:'best',     header:'BEST VALUE!',  headerClass:'gpo-help-best',     badgeClass:'gpo-badge-best' };
      if (t.includes('pro'))    return { key:'pros',     header:'FOR PROS',     headerClass:'gpo-help-pros',     badgeClass:'gpo-badge-pros' };
      return null;
    }

    function markFullWidth(){
      document.querySelectorAll('.gpo-element.gpo-form__group').forEach(group => {
        const title = (group.querySelector('.gpo-label .label-content')?.textContent || '').toLowerCase();
        group.classList.toggle('fullwidth', title.includes('wood type') || title.includes('heater size'));
      });
    }

    function buildTierMap(group){
      const map = new Map();
      group.querySelectorAll('.gpo-swatches.gpo-ov-item').forEach(item => {
        const input = item.querySelector('input[gpo-data-variant-id]');
        if (!input) return;
        const vid = input.getAttribute('gpo-data-variant-id');

        let key = input.getAttribute('data-tier');
        if (key === null){
          const helpEl = item.querySelector('.gpo-tooltip__title .gpo-ov-helptext');
          const tier = tierFrom(helpEl ? helpEl.textContent : '');
          key = tier ? tier.key : '';
          input.setAttribute('data-tier', key);
        }
        if (key){
          if (key === 'starters') map.set(vid, { key, header:'FOR STARTERS', headerClass:'gpo-help-starters' });
          if (key === 'best')     map.set(vid, { key, header:'BEST VALUE!',  headerClass:'gpo-help-best'});
          if (key === 'pros')     map.set(vid, { key, header:'FOR PROS',     headerClass:'gpo-help-pros'});
        }
      });
      return map;
    }

    function applyTiers(group){
      const wrap = group.querySelector('.gpo-ov-wrapper.horizontal');
      if (!wrap) return;

      const tierMap = buildTierMap(group);
      if (!tierMap.size) return;

      const cards = Array.from(wrap.querySelectorAll('.custom-variant-card[data-variant-id]'));
      if (!cards.length) return;

      // Insert a header before EACH card (not just first of each tier)
      cards.forEach(card => {
        const vid = card.getAttribute('data-variant-id');
        const tier = tierMap.get(vid);
        if (!tier) return;

        // Check if there's already a header directly before this card
        const prev = card.previousElementSibling;
        const hasHeader = prev && prev.classList && prev.classList.contains('gpo-help-header');
        
        if (!hasHeader) {
          const h = document.createElement('div');
          h.className = `gpo-help-header ${tier.headerClass}`;
          h.textContent = tier.header;
          wrap.insertBefore(h, card);
          console.log(`ðŸ“Œ Added header "${tier.header}" before card ${vid}`);
        }
      });
    }

    function run(){
      markFullWidth();
      document.querySelectorAll('.gpo-element.gpo-form__group').forEach(group => applyTiers(group));
    }

    const ready = () => {
      run();
      // retry a few times to catch late tooltip internals
      let tries = 0, maxTries = 10;
      const int = setInterval(() => { run(); if (++tries >= maxTries) clearInterval(int); }, 200);
      const mo = new MutationObserver(() => run());
      mo.observe(document.body, { childList:true, subtree:true });
      setTimeout(() => {
        console.log('[GPO tiers] help spans found:', document.querySelectorAll('.gpo-tooltip__title .gpo-ov-helptext').length);
      }, 1200);
    };

    (document.readyState === 'loading') ? document.addEventListener('DOMContentLoaded', ready) : ready();
  })();
</script>
