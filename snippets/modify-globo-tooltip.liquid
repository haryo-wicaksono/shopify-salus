{% assign variant_metafields_string = '' %}
{% for product in collections['uncategorized'].products %}
  {% for variant in product.variants %}
    {% if variant.metafields.global.description != blank %}
      {% assign variant_metafields_string = variant_metafields_string | append: variant.id | append: '<delimiter_first>' | append: variant.metafields.global.description | append: '<delimiter_second>' %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% liquid
  assign last_character = variant_metafields_string | slice: -1
  assign vms_length_min_one = variant_metafields_string.size | minus: 1
%}
{% if last_character == '<delimiter_second>' %}
  {% assign variant_metafields_string = variant_metafields_string | slice: 0, vms_length_min_one %}
{% endif %}

{% assign variant_real_price_string = '' %}
{% for product in collections['uncategorized'].products %}
  {% for variant in product.variants %}
    {% if variant.metafields.custom.real_price != blank %}
      {% assign variant_real_price_string = variant_real_price_string | append: variant.id | append: '<delimiter_first>' | append: variant.metafields.custom.real_price | append: '<delimiter_second>' %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% liquid
  assign last_character_vrp = variant_real_price_string | slice: -1
  assign vrp_length_min_one = variant_real_price_string.size | minus: 1
%}
{% if last_character_vrp == '<delimiter_second>' %}
  {% assign variant_real_price_string = variant_real_price_string | slice: 0, vrp_length_min_one %}
{% endif %}

{% assign variant_card_tag_string = '' %}
{% for product in collections['uncategorized'].products %}
  {% for variant in product.variants %}
    {% if variant.metafields.custom.card_tag != blank %}
      {% assign variant_card_tag_string = variant_card_tag_string | append: variant.id | append: '<delimiter_first>' | append: variant.metafields.custom.card_tag | append: '<delimiter_second>' %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% liquid
  assign last_character_vct = variant_card_tag_string | slice: -1
  assign vct_length_min_one = variant_card_tag_string.size | minus: 1
%}
{% if last_character_vct == '<delimiter_second>' %}
  {% assign variant_card_tag_string = variant_card_tag_string | slice: 0, vct_length_min_one %}
{% endif %}

{%  style  %}
  .globo-popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 100;
    color: white;
  }

  .globo-popup .price__was {
    color: #595959 ;
  }

  .globoPopUp-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #212C36;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 92%;
    max-height: 450px;
    transition: transform 0.3s ease;
    padding: 15px
  }
{% endstyle %}

<script>
  const vmsString = {{variant_metafields_string |  json}};
  const vrpString = {{variant_real_price_string |  json}};
  const vctString = {{variant_card_tag_string |  json}};

  const vmMap = new Map();
  const vrpMap = new Map();
  const vctMap = new Map();

  vrpString
    .split("<delimiter_second>")
    .map((val) => val.split("<delimiter_first>"))
    .forEach(([id, price]) => {
      vrpMap.set(id, price);
    });

  vmsString
    .split("<delimiter_second>")
    .map((val) => val.split("<delimiter_first>"))
    .forEach(([id, description]) => {
      vmMap.set(id, description);
    });

  vctString
    .split("<delimiter_second>")
    .map((val) => val.split("<delimiter_first>"))
    .forEach(([id, tag]) => {
      vctMap.set(id, tag);
    });

  // GPO Load Observer: Now runs on ALL image swatches as they load
  document.addEventListener("DOMContentLoaded", function () {
      const targetNode = document.body;
      let hasRun = false;
      const callback = function (mutationsList, observer) {
          mutationsList.forEach(() => {
              // Check for any GPO image swatch element
              if (document.querySelector('.gpo-swatches.image-swatches')) {
                  if (!hasRun) {
                    hasRun = true;
                    observer.disconnect(); 
                    priceCompareAndBuildOptions();
                  }
              }
          });
      };
      const observer = new MutationObserver(callback);
      const config = { childList: true, subtree: true };
      observer.observe(targetNode, config);
  });
  
  // Main logic to rebuild the option cards
  function priceCompareAndBuildOptions() { 
    // Target ALL option groups
    const optionGroups = document.querySelectorAll('.gpo-element');
    
    optionGroups.forEach(groupElement => {
      const isImageSwatchGroup = groupElement.querySelector('.gpo-swatches.image-swatches');
      if (!isImageSwatchGroup) return; 

      const inputs = groupElement.querySelectorAll("input[gpo-data-variant-id]");
      const variantIdsSet = [... new Set(Array.from(inputs).map(input => input.getAttribute("gpo-data-variant-id")))];

      for (let val of variantIdsSet) {
          const parentInput = groupElement.querySelector(`input[gpo-data-variant-id="${val}"]`);
          const optionCard = parentInput.closest('.gpo-ov-item');
          if (!optionCard) continue;

          // --- DATA RETRIEVAL ---
          const customTag = vctMap.get(val);
          const labelElement = optionCard.querySelector('label');
          
          // Get data from the original GPO structure (tooltip is the source of rich data)
          const gpoTooltipTitleDiv = parentInput.nextElementSibling?.querySelector(".gpo-tooltip__title");
          const gpoTooltipImageDiv = parentInput.nextElementSibling?.querySelector(".gpo-tooltip__image");
          const swatchInner = optionCard.querySelector('.gpo-swatch__inner');

          const addOnSpan = gpoTooltipTitleDiv?.querySelector(".addOn");
          const priceAddOnValue = addOnSpan?.textContent.trim() || '';
          
          // FIX: Get Title - Use the most reliable raw input data (the value attribute)
          const optionTitle = parentInput.getAttribute('value') || 'N/A';
          
          // FIX: Price Logic - Determine if it is a paid upgrade
          const isExplicitlyFreeInGPO = priceAddOnValue.includes('0 USD') || priceAddOnValue === '';
          let showPriceDisplay = false;

          // 1. Check if the Real Price Metafield exists and is > 0 (Strongest PAID indicator)
          if (vrpMap.has(val)) {
              const realPriceValue = parseInt(vrpMap.get(val));
              if (realPriceValue > 0) {
                  showPriceDisplay = true;
              }
          }
          // 2. Check if the GPO element itself had an addOn price (to catch non-discounted paid items)
          if (addOnSpan && !isExplicitlyFreeInGPO) {
              showPriceDisplay = true;
          }
          
          // --- CRITICAL FIX: Clear label and get image HTML ---
          // Prioritize the large image HTML from the tooltip, fallback to the inner swatch's HTML
          const imageHtmlFromTooltip = gpoTooltipImageDiv ? gpoTooltipImageDiv.innerHTML : '';
          const imageHtmlFromSwatch = swatchInner ? swatchInner.innerHTML : '';
          const imageHtml = imageHtmlFromTooltip || imageHtmlFromSwatch; 

          labelElement.innerHTML = ''; // Forcefully clear the label's inner HTML (removes duplicate/old content)

          // --- INJECT CUSTOM HEADER/TAG ---
          if (customTag) {
              const headerDiv = document.createElement('div');
              headerDiv.className = 'custom-option-header';
              const tagClass = customTag.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
              headerDiv.classList.add(tagClass);
              
              if (customTag.toUpperCase().includes('PROS')) {
                  headerDiv.innerHTML = `${customTag} <span class="star-icon">â˜…</span>`;
              } else {
                  headerDiv.textContent = customTag;
              }
              optionCard.prepend(headerDiv);
          }

          // --- REBUILD CONTENT AREA ---
          const contentWrapper = document.createElement('div');
          contentWrapper.className = 'custom-option-content-wrapper';
          const infoDiv = document.createElement('div');
          infoDiv.className = 'custom-option-info';

          // Re-inject image
          const imgWrapper = document.createElement('div');
          imgWrapper.className = 'custom-option-img-wrapper';
          const newSwatchInner = document.createElement('span');
          newSwatchInner.className = swatchInner ? swatchInner.className : 'gpo-swatch__inner'; 
          newSwatchInner.innerHTML = imageHtml; 
          imgWrapper.appendChild(newSwatchInner);
          
          contentWrapper.appendChild(imgWrapper);
          contentWrapper.appendChild(infoDiv);

          labelElement.appendChild(contentWrapper); 

          const titleH4 = document.createElement('h4');
          titleH4.textContent = optionTitle;
          infoDiv.appendChild(titleH4);
          
          // --- INJECT PRICE/FREE TEXT ---
          if (!showPriceDisplay) {
              const freeText = document.createElement('p');
              freeText.className = 'custom-option-price-free';
              freeText.textContent = 'FREE - Included with your order';
              infoDiv.appendChild(freeText);
          } else { // It is a paid upgrade
              const priceDiv = document.createElement("div");
              priceDiv.className = 'custom-option-price-details';
              
              const value = priceAddOnValue;
              const valNum = value.match(/[\d,]+/)?.[0]?.replace(/,/g, "") || "0";
              const priceCurrValue = parseInt(valNum);
              
              const priceCurr = document.createElement("span");
              priceCurr.textContent = `$${priceCurrValue.toLocaleString("en-US")} USD`;
              priceCurr.classList.add('price__current');

              const savePrice = document.createElement("span");
              const priceWas = document.createElement("s");

              if (vrpMap.has(val)) {
                  const realPriceValue = parseInt(vrpMap.get(val));
                  const savedAmount = realPriceValue - priceCurrValue;

                  priceWas.textContent = `$${realPriceValue.toLocaleString("en-US")} USD`;
                  priceWas.classList.add('price__was', 'strikethrough-red');

                  savePrice.textContent = `SAVE $${savedAmount.toLocaleString("en-US")}!`;
                  savePrice.classList.add("discount__price");

                  priceDiv.appendChild(priceCurr);
                  priceDiv.appendChild(savePrice);
                  priceDiv.appendChild(priceWas);
              } else {
                  // Fallback: If no real_price metafield, just show the current GPO price
                  // Note: priceCurrValue will be 0 if addOnSpan was missing, resulting in $0 USD
                  priceDiv.appendChild(priceCurr);
              }
              
              infoDiv.appendChild(priceDiv);
          }
      
          // --- SELECTION HIGHLIGHT LOGIC ---
          if (parentInput.checked) {
              optionCard.classList.add('is-selected');
          }

          parentInput.addEventListener('change', (e) => {
              const groupWrapper = e.target.closest('.gpo-ov-wrapper');
              groupWrapper.querySelectorAll('.gpo-ov-item').forEach(item => {
                  item.classList.remove('is-selected');
              });
              if (e.target.checked) {
                  optionCard.classList.add('is-selected');
              }
          });
      }
    });
  }
  
  // Utility functions (kept as is)
  function waitForElement(selector, callback) {
    const observer = new MutationObserver(() => {
      const el = document.querySelector(selector);
      if (el) {
        observer.disconnect();
        callback(el);
      }
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });
  }

  function addAltTextToImages (selector) { 
    return () => {
      const divImages = document.querySelectorAll(selector);
      divImages.forEach((divImg) => {
        let img = null;
        if (divImg.tagName.toLowerCase() === 'img') {
          img = divImg;
        } else {
          img = divImg.querySelector('img');
        }
        if (img && img.tagName.toLowerCase() === 'img' && !img.hasAttribute('alt')) {
          img.setAttribute('alt', 'Product Image');
        }
      });
    };
  }

  waitForElement('.gpo-swatches.image-swatches', priceCompareAndBuildOptions);
  waitForElement('.gpo-swatch__image', addAltTextToImages('.gpo-swatch__image'));
  waitForElement('.gpo-tooltip__image', addAltTextToImages('.gpo-tooltip__image'));
</script>