{% assign variant_metafields_string = '' %}
{% for product in collections.uncategorized.products %}
  {% for variant in product.variants %}
    {% if variant.metafields.global.description != blank %}
      {% assign variant_metafields_string = variant_metafields_string
        | append: variant.id
        | append: '<delimiter_first>'
        | append: variant.metafields.global.description
        | append: '<delimiter_second>'
      %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% assign variant_real_price_string = '' %}
{% for product in collections.uncategorized.products %}
  {% for variant in product.variants %}
    {% if variant.metafields.custom.real_price != blank %}
      {% assign variant_real_price_string = variant_real_price_string
        | append: variant.id
        | append: '<delimiter_first>'
        | append: variant.metafields.custom.real_price
        | append: '<delimiter_second>'
      %}
    {% endif %}
  {% endfor %}
{% endfor %}

{% style %}
  /* Hide original Globo tooltips, swatch images, and labels (we render cards) */
  .gpo-tooltip.zoom-image,
  .gpo-swatch__image,
  .gpo-ov-item label {
    display: none !important;
  }

  /* Also hide the original GPO items (keep in DOM for data scraping) */
  .gpo-swatches.image-swatches.gpo-ov-item {
    display: none;
  }

  /* Card styles - simplified to match target */
  .custom-variant-card {
    border: 1px solid #b4b4b4;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 0;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 16px;
    position: relative;
    width: 100%;
  }
  .custom-variant-card:hover {
    border-color: #b4b4b4;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  .custom-variant-card.selected {
    border-color: #000000;
    border-width: 1px;
    padding: 15px;
    background: #f1f1f1;
  }

  .card-image-container {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f9fafb;
    border-radius: 6px;
    overflow: hidden;
  }
  .card-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .card-content {
    flex: 1;
    min-width: 0;
  }
  .card-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0px;
    color: #222120;
    line-height: 1.4;
  }

  .card-price-section {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 4px;
  }
  .card-price-current {
    font-size: 14px;
    font-weight: 500;
    color: #222120;
  }
  .card-save-badge {
    background: #1f8a81;
    color: #fff;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
  }
  .card-price-was {
    font-size: 14px;
    color: #f03636;
    text-decoration: line-through;
    font-weight: 500;
  }
  .card-free-badge {
    color: #222120;
    font-size: 14px;
    font-weight: 400;
  }

  input[gpo-data-variant-id] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  @media (max-width: 768px) {
    .custom-variant-card {
      flex-direction: row;
      text-align: left;
    }
    .card-image-container {
      width: 56px;
      height: 56px;
    }
    .card-title {
      font-size: 14px;
    }
    .card-price-current {
      font-size: 15px;
    }
  }

  /* Freebies visual tweak */
  .freebies .custom-variant-card {
    background: #f5f5f5;
    border-color: #000;
  }

  /* Layout: default 2 columns for groups, 1 col on mobile */
  .gpo-element .gpo-ov-wrapper.horizontal {
    display: grid !important;
    /* grid-template-columns: repeat(2, minmax(0,1fr)) !important; */
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }

  .gpo-element .gpo-ov-wrapper.horizontal:has(.gpo-help-header) {
    gap: 0px !important;
  }

  @media (max-width: 768px) {
    .gpo-element .gpo-ov-wrapper.horizontal {
      grid-template-columns: 1fr !important;
    }
  }
  /* Only Wood Type & Heater Size become full-width */
  .gpo-element.fullwidth .gpo-ov-wrapper.horizontal {
    grid-template-columns: 1fr !important;
  }

  /* Tier headers - each card gets its own header */
  .gpo-help-header {
    font-weight: 600;
    font-size: 16px;
    letter-spacing: 0.5px;
    padding: 10px 16px;
    border-radius: 10px 10px 0 0;
    margin: 0 0 0 0;
    color: #fff;
    text-align: center;
    text-transform: uppercase;
    grid-column: 1 / -1;
    border-top: 1px solid #b4b4b4;
    border-left: 1px solid #b4b4b4;
    border-right: 1px solid #b4b4b4;
  }
  .gpo-help-starters {
    background: #ffffff;
    border-top: 1px solid #b4b4b4;
    border-left: 1px solid #b4b4b4;
    border-right: 1px solid #b4b4b4;
    /* border-bottom: 1px solid #B4B4B4; */
    color: #222120;
  }
  .gpo-help-best {
    background: #1f8a81;
    border-top: 1px solid #b4b4b4;
    border-left: 1px solid #b4b4b4;
    border-right: 1px solid #b4b4b4;
    color: #ffffff;
  }
  .gpo-help-pros {
    background: #222120;
    border-top: 1px solid #b4b4b4;
    border-left: 1px solid #b4b4b4;
    border-right: 1px solid #b4b4b4;
    color: #ffffff;
  }

  .gpo-help-starters:has(+ .custom-variant-card.selected) {
    border-top: 1px solid #000000;
    border-left: 1px solid #000000;
    border-right: 1px solid #000000;
  }
  .gpo-help-best:has(+ .custom-variant-card.selected) {
    border-top: 1px solid #000000;
    border-left: 1px solid #000000;
    border-right: 1px solid #000000;
  }
  .gpo-help-pros:has(+ .custom-variant-card.selected) {
    border-top: 1px solid #000000;
    border-left: 1px solid #000000;
    border-right: 1px solid #000000;
  }

  /* Card directly after header connects to it */
  .gpo-help-header + .custom-variant-card {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    margin-top: 0;
    gap: 0px;
  }

  .gpo-ov-wrapper.horizontal > .gpo-help-header {
    margin-top: 10px;
  }

  /* First header in the wrapper has no top margin */
  .gpo-ov-wrapper.horizontal > .gpo-help-header:first-child {
    margin-top: 0;
  }

  /* Wood Type specific styling */
  .wood-type-group .gpo-ov-wrapper.horizontal {
    display: block !important; /* Override grid to allow auto width */
  }

  .wood-type-group .custom-variant-card {
    border: 1px solid #b4b4b4;
    background: #f1f1f1;
    border-radius: 10px;
    padding: 16px;
    gap: 16px;
    margin-top: 10px;
    width: 100%;
    display: inline-flex;
  }

  .wood-type-group .custom-variant-card:first-of-type {
    margin-top: 0 !important;
  }

  /* Wood Type image - circular and smaller */
  /* .wood-type-group .card-image-container {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: transparent;
  } */

  /* .wood-type-group .card-image {
    border-radius: 50%;
  } */

  /* Wood Type title styling */
  .wood-type-group .card-title {
    font-size: 16px;
    font-weight: 600;
    color: #222120;
    margin: 0;
    line-height: 1.5;
  }

  /* Hide "FREE - Included with your order" for Wood Type */
  .wood-type-group .card-free-badge {
    display: none;
  }

  .wood-type-group .custom-variant-card {
    border-color: #b4b4b4;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    background-color: #ffffff;
  }

  .wood-type-group .custom-variant-card.show-free-badge .card-free-badge {
    display: inline-block;
  }

  /* Wood Type hover state */
  .wood-type-group .custom-variant-card:hover {
    border-color: #000000;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Wood Type selected state */
  .wood-type-group .custom-variant-card.selected {
    border-color: #000000;
    border-width: 1px;
    background: #f5f5f5;
  }

  .has-star {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .gpo-help-header.gpo-help-best p,
  .gpo-help-header.gpo-help-starters p {
    margin: 0px;
  }

  .gpo-help-header.gpo-help-pros p {
    margin-bottom: 0px;
    margin-top: 4px;
    display: inline-flex;
    justify-content: center;
    align-content: center;
  }

  .gpo-help-header.gpo-help-pros svg {
    width: 17px;
    height: 17px;
    margin-left: 5px;
    display: inline-flex;
    justify-content: center;
    align-content: center;
  }
  .gpo-help-header.gpo-help-pros svg path {
    background-color: #33b6ab;
    fill: #33b6ab;
  }

  @media screen and (max-width: 768px) {
    .product-info__block.product-info__block--sm.product-price {
      margin-bottom: 0px;
    }
    .product-info__block.product-info__block--sm.product-info__pay {
      margin-top: 0px;
    }
    .wood-type-group .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .gpo-help-header {
      font-size: 14px;
    }
  }
  /* === Card Content Layout === */
  .card-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  /* === Header Row (Desktop) === */
  .card-header-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }

  .card-header-row .card-title {
    flex: 1 1 auto; /* Title takes all available space */
  }

  /* === Base Button Style (Both Desktop + Mobile) === */
  .card-desc-toggle {
    border: 1px solid #b4b4b4;
    padding: 3px 14px;
    border-radius: 999px;
    font-size: 12px;
    background: #f5f5f5;
    cursor: pointer;
    flex-shrink: 0;
    min-width: 60px;
  }

  .card-desc-toggle:hover {
    background: #e7e7e7;
  }

  /* Desktop button alignment (right side of title row) */
  .card-desc-toggle--desktop {
    margin-left: auto;
  }

  /* === Mobile Layout === */
  @media (max-width: 768px) {
    /* Header row stacks vertically on mobile */
    .card-header-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    /* Desktop button hidden on mobile */
    .card-desc-toggle--desktop {
      display: none;
    }

    /* Mobile button visible & full-width */
    .card-desc-toggle--mobile {
      display: block;
      width: 100%;
      text-align: center;
      padding: 5px 14px;
      margin-top: 7px;
      font-size: 14px;
      border-radius: 20px;
      background: #efefef;
    }
  }

  /* Desktop visibility (inverse of mobile) */
  @media (min-width: 769px) {
    .card-desc-toggle--desktop {
      display: inline-block;
    }
    .card-desc-toggle--mobile {
      display: none;
    }
  }

  /* === Smooth Description Dropdown Animation === */
  .card-description {
    /* margin-top: 8px; */
    font-size: 13px;
    color: #444;
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    /* transition:
      max-height 0.5s linear,
      margin-top 0.2s linear,
      opacity 0.5s linear; */
  }

  .card-main ~ .card-description.open {
    margin-top: 0px;
  }

  .card-main:has(~ .card-description.open) {
    margin-bottom: 10px;
  }

  .card-description.open {
    max-height: 500px; /* Enough for long descriptions */
    opacity: 1;
  }

  /* Card is now a vertical stack: row at top, then mobile button, then description */
  .custom-variant-card {
    border: 1px solid #b4b4b4;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 0;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 8px; /* space between main row, button, description */
  }

  /* Row that holds image + content */
  .card-main {
    display: flex;
    align-items: center;
    gap: 16px;
    /* transition: margin-bottom 0.2s linear; */
  }

  .card-image-container {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f9fafb;
    border-radius: 6px;
    overflow: hidden;
  }

  .card-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .card-header-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .card-header-main {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .card-desc-toggle {
    border: 1px solid #b4b4b4;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 12px;
    background: #f5f5f5;
    cursor: pointer;
    flex-shrink: 0;
    min-width: 60px;
  }

  .card-desc-toggle:hover {
    background: #e7e7e7;
  }

  /* Desktop */
  @media (min-width: 769px) {
    .card-desc-toggle--desktop {
      display: inline-block;
      margin-left: auto; /* push to right side of the header row */
    }
    .card-desc-toggle--mobile {
      display: none;
    }
  }

  /* Mobile */
  @media (max-width: 768px) {
    /* header row stays row: image+content unaffected via .card-main */

    .card-desc-toggle--desktop {
      display: none;
    }

    .card-main:has(~ .card-description.open) {
      margin-bottom: 0px;
    }

    .card-main ~ .card-description.open {
      margin-top: 10px;
    }

    .card-desc-toggle--mobile {
      display: block;
      width: 100%;
      align-self: stretch; /* full width of card */
      text-align: center;
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 20px;
      background: #efefef;
      margin-top: 4px;
    }
  }

  /* Top-level card: vertical stack but LEFT aligned */
  .custom-variant-card {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: stretch; /* not center */
    text-align: left; /* default text left */
  }

  /* Row that holds image + title/price */
  .card-main {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  /* Title + price block */
  .card-header-main {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    text-align: left;
  }

  /* Make sure price + description also stay left */
  .card-price-section,
  .card-description {
    text-align: left;
  }

  .card-desc-toggle {
    border: 1px solid #b4b4b4;
    padding: 6px 14px;
    border-radius: 999px;
    font-size: 12px;
    background: #f5f5f5;
    cursor: pointer;
    flex-shrink: 0;
    min-width: 60px;
    text-align: center; /* center JUST the button label */
  }

  @media (max-width: 768px) {
    .card-desc-toggle--mobile {
      display: block;
      width: 100%;
      align-self: stretch;
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 20px;
      background: #efefef;
      margin-top: 15px;
    }
  }
{% endstyle %}

<script>
  /* === Build cards from GPO tooltips (kept as-is, minor safety tweaks) === */
  const vmsString = {{ variant_metafields_string | default: '' | json }};
  const vrpString = {{ variant_real_price_string | default: '' | json }};

  const vmMap = new Map();
  const vrpMap = new Map();
  const processedCards = new Set();
  const inputCache = new Map();

  if (vrpString) {
    vrpString.split("<delimiter_second>").forEach((segment) => {
      const [id, price] = segment.split("<delimiter_first>");
      if (id && price) vrpMap.set(id, price);
    });
  }
  if (vmsString) {
    vmsString.split("<delimiter_second>").forEach((segment) => {
      const [id, description] = segment.split("<delimiter_first>");
      if (id && description) vmMap.set(id, description);
    });
  }

  function getCachedInput(variantId){
    if (inputCache.has(variantId)) return inputCache.get(variantId);
    const input = document.querySelector(`input[gpo-data-variant-id="${variantId}"]`);
    if (input) inputCache.set(variantId, input);
    return input;
  }

  function getImageUrl(input){
    if (!input || !input.nextElementSibling) return '';
    const container = input.nextElementSibling;

    let img = container.querySelector('.gpo-swatch__inner .swatch-image');
    if (img?.src) return img.src;

    img = container.querySelector('.gpo-swatch__image');
    if (img) return img.src || img.getAttribute('data-src') || '';

    img = container.querySelector('.gpo-tooltip__image img');
    if (img) return img.src || img.getAttribute('data-src') || '';

    img = container.querySelector('img');
    if (img) return img.src || img.getAttribute('data-src') || '';

    const label = container.querySelector('label');
    if (label){
      img = label.querySelector('img');
      if (img) return img.src || img.getAttribute('data-src') || '';
    }

    const withBg = container.querySelectorAll('[style*="background-image"]');
    for (const el of withBg){
      const m = (el.style.backgroundImage || '').match(/url\(['"]?(.*?)['"]?\)/);
      if (m?.[1]) return m[1];
    }
    return '';
  }

  // Sync visual state when input changes (triggered by Globo or user)
  function syncCardWithInput(input) {
    const variantId = input.getAttribute('gpo-data-variant-id');
    const card = document.querySelector(`.custom-variant-card[data-variant-id="${variantId}"]`);
    
    if (card) {
      if (input.checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    }
  }

  function buildVariantCards(){
    const inputs = document.querySelectorAll('input[gpo-data-variant-id]');
    if (!inputs.length) return;

    inputCache.clear();
    const variantIds = new Set();
    inputs.forEach(i => {
      const id = i.getAttribute('gpo-data-variant-id');
      if (id) variantIds.add(id);
    });

    let cardsCreated = 0;

    variantIds.forEach((variantId) => {
      if (processedCards.has(variantId)) return;

      const input = getCachedInput(variantId);
      if (!input) return;

      const tooltipParent = input.nextElementSibling?.querySelector('div.gpo-tooltip');
      if (!tooltipParent) return;

      const childDivs = tooltipParent.querySelectorAll('div');
      if (!childDivs.length) return;

      let productName = '';
      let priceHTML = '';
      let isFree = false;          // ðŸ”¹ NEW
      const imageUrl = getImageUrl(input);

      for (let i=0; i<childDivs.length; i++){
        if (childDivs[i].classList.contains('gpo-tooltip__title')) {
          const titleClone = childDivs[i].cloneNode(true);
          const addOn = titleClone.querySelector('.addOn');

          if (addOn) {
            const value = addOn.textContent.trim();
            const match = value.match(/[\d,]+/);
            addOn.remove();

            const tierHelp = titleClone.querySelector('.gpo-ov-helptext');
            if (tierHelp) tierHelp.remove();

            productName = titleClone.textContent.trim();

            if (match){
              const valNum = match[0].replace(/,/g, '');
              if (valNum && valNum !== '0') {
                const currentPrice = parseInt(valNum, 10);
                const currentPriceFormatted = `$${currentPrice.toLocaleString('en-US')}`;

                if (vrpMap.has(variantId)) {
                  const realPriceNum = parseInt(vrpMap.get(variantId), 10);
                  const savings = realPriceNum - currentPrice;
                  priceHTML = `
                    <div class="card-price-section">
                      <span class="card-price-current">${currentPriceFormatted}</span>
                      <span class="card-save-badge">Save $${savings.toLocaleString('en-US')}</span>
                      <span class="card-price-was">$${realPriceNum.toLocaleString('en-US')} USD</span>
                    </div>`;
                } else {
                  priceHTML = `
                    <div class="card-price-section">
                      <span class="card-price-current">${currentPriceFormatted}</span>
                    </div>`;
                }
              } else {
                // ðŸ”¹ FREE CASE
                isFree = true;
                priceHTML = '<div class="card-free-badge">FREE - Included with your order</div>';
              }
            } else {
              // ðŸ”¹ FREE CASE (no numeric match)
              isFree = true;
              priceHTML = '<div class="card-free-badge">FREE - Included with your order</div>';
            }
          } else {
            // ðŸ”¹ FREE CASE (no .addOn)
            const titleClone2 = childDivs[i].cloneNode(true);
            const tierHelp2 = titleClone2.querySelector('.gpo-ov-helptext');
            if (tierHelp2) tierHelp2.remove();
            productName = titleClone2.textContent.trim();
            isFree = true;
            priceHTML = '<div class="card-free-badge">FREE - Included with your order</div>';
          }
          break;
        }
      }


      if (!productName) return;

      const description = vmMap.get(variantId) || '';
      const hasDescription = !!description;

      const card = document.createElement('div');
      card.className = 'custom-variant-card';
      card.setAttribute('data-variant-id', variantId);
      {% comment %} card.innerHTML = `
        ${imageUrl ? `<div class="card-image-container"><img src="${imageUrl}" alt="${productName}" class="card-image"></div>` : ``}
        <div class="card-content">
          <h3 class="card-title">${productName}</h3>
          ${priceHTML}
        </div>`; {% endcomment %}
      {% comment %} card.innerHTML = `
        ${imageUrl ? `<div class="card-image-container"><img src="${imageUrl}" alt="${productName}" class="card-image"></div>` : ``}
        <div class="card-content">

          <div class="card-header-row">
            <h3 class="card-title">${productName}</h3>
            ${hasDescription ? `<button type="button" class="card-desc-toggle" aria-expanded="false">Details</button>` : ``}
          </div>

          ${priceHTML}

          ${hasDescription ? `<div class="card-description">${description}</div>` : ``}
        </div>`; {% endcomment %}

      {% comment %} card.innerHTML = `
        ${imageUrl ? `<div class="card-image-container"><img src="${imageUrl}" alt="${productName}" class="card-image"></div>` : ``}
        <div class="card-content">

          <div class="card-header-row">
            <h3 class="card-title">${productName}</h3>
            ${hasDescription ? `
              <button type="button"
                      class="card-desc-toggle card-desc-toggle--desktop"
                      aria-expanded="false">
                Details
              </button>` : ``}
          </div>

          ${priceHTML}

          ${hasDescription ? `
            <button type="button"
                    class="card-desc-toggle card-desc-toggle--mobile"
                    aria-expanded="false">
              Details
            </button>` : ``}

          ${hasDescription ? `<div class="card-description">${description}</div>` : ``}
        </div>`; {% endcomment %}
      card.innerHTML = `
        <div class="card-main">
          ${imageUrl ? `
            <div class="card-image-container">
              <img src="${imageUrl}" alt="${productName}" class="card-image">
            </div>` : ``}

          <div class="card-content">
            <div class="card-header-row">
              <div class="card-header-main">
                <h3 class="card-title">${productName}</h3>
                ${priceHTML}
              </div>

              ${hasDescription ? `
                <button type="button"
                        class="card-desc-toggle card-desc-toggle--desktop"
                        aria-expanded="false">
                  Details
                </button>` : ``}
            </div>
          </div>
        </div>

        ${hasDescription ? `
          <button type="button"
                  class="card-desc-toggle card-desc-toggle--mobile"
                  aria-expanded="false">
            Details
          </button>` : ``}

        ${hasDescription ? `<div class="card-description">${description}</div>` : ``}
      `;



      {% comment %} if (hasDescription) {
        const toggleBtn = card.querySelector('.card-desc-toggle');
        const descEl = card.querySelector('.card-description');

        // Start closed: no .open class

        toggleBtn.addEventListener('click', (event) => {
          event.preventDefault();
          event.stopPropagation();

          const isOpen = descEl.classList.contains('open');

          if (isOpen) {
            // Closing
            descEl.classList.remove('open');
            toggleBtn.textContent = 'Details';
            toggleBtn.setAttribute('aria-expanded', 'false');
          } else {
            // Opening
            descEl.classList.add('open');
            toggleBtn.textContent = 'Hide';
            toggleBtn.setAttribute('aria-expanded', 'true');
          }
        });
      } {% endcomment %}

      if (hasDescription) {
        const desktopBtn = card.querySelector('.card-desc-toggle--desktop');
        const mobileBtn  = card.querySelector('.card-desc-toggle--mobile');
        const descEl     = card.querySelector('.card-description');

        function setState(isOpen) {
          if (isOpen) {
            descEl.classList.add('open');
          } else {
            descEl.classList.remove('open');
          }

          const label = isOpen ? 'Hide' : 'Details';
          const expanded = isOpen ? 'true' : 'false';

          if (desktopBtn) {
            desktopBtn.textContent = label;
            desktopBtn.setAttribute('aria-expanded', expanded);
          }
          if (mobileBtn) {
            mobileBtn.textContent = label;
            mobileBtn.setAttribute('aria-expanded', expanded);
          }
        }

        function toggleDesc(event) {
          event.preventDefault();
          event.stopPropagation();

          const isOpen = descEl.classList.contains('open');
          setState(!isOpen);
        }

        if (desktopBtn) desktopBtn.addEventListener('click', toggleDesc);
        if (mobileBtn)  mobileBtn.addEventListener('click', toggleDesc);

        // start collapsed
        setState(false);
      }


      card.addEventListener('click', (e) => {
        e.preventDefault();

        const inFreebies = input.closest('.freebies') !== null;

        // Check if this card belongs to a Wood Type group
        const woodTypeGroup = input.closest('.wood-type-group');
        const woodTypeInputsCount = woodTypeGroup
          ? woodTypeGroup.querySelectorAll('input[gpo-data-variant-id]').length
          : 0;

        const parentGroup = input.closest('.gpo-element.gpo-form__group');
        const groupLabelText = parentGroup
          ? (parentGroup.querySelector('.gpo-label .label-content')?.textContent || '').toLowerCase()
          : '';
        const isWaterproofBoxesGroup = groupLabelText.includes('waterproof boxes');

        // BLOCK click for:
        //  - freebies (always)
        //  - wood type ONLY when there is exactly 1 option
        const blockWoodTypeClick = woodTypeGroup && woodTypeInputsCount === 1;
        if (inFreebies || blockWoodTypeClick) return;

        // --- normal toggle logic ---
        let newChecked = input.checked;

        if (input.type === 'checkbox') {
          newChecked = !input.checked;
          input.checked = newChecked;
        } else if (input.type === 'radio') {
          const siblings = document.querySelectorAll(
            `input[type="radio"][name="${input.name}"][gpo-data-variant-id]`
          );
          if (siblings.length === 1 && input.checked) {
            newChecked = false;
            input.checked = false;
          } else {
            newChecked = true;
            input.checked = true;
          }
        }

        // ðŸ”¹ If this is the Waterproof Boxes group, mirror state to the other box
        if (isWaterproofBoxesGroup && parentGroup) {
          const pairInputs = parentGroup.querySelectorAll('input[gpo-data-variant-id]');
          pairInputs.forEach((inp) => {
            if (inp !== input) {
              inp.checked = newChecked;
              inp.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        }

        // Fire change for clicked input
        input.dispatchEvent(new Event('change', { bubbles: true }));

        // Re-sync all cards in this name group
        const nameGroupInputs = document.querySelectorAll(`input[name="${input.name}"]`);
        nameGroupInputs.forEach((inp) => {
          const vId = inp.getAttribute('gpo-data-variant-id');
          const c = document.querySelector(`.custom-variant-card[data-variant-id="${vId}"]`);
          if (c) c.classList.toggle('selected', !!inp.checked);
        });
      });


      // AUTO-SELECT FIRST WOOD TYPE VARIANT
      if (input.closest('.wood-type-group') && !document.querySelector('.wood-type-group input:checked')) {
        input.checked = true;
        card.classList.add('selected');
      }


      // Add change listener to sync when Globo changes the input
      input.addEventListener('change', () => {
        const parentGroup = input.closest('.gpo-element.gpo-form__group');
        const groupLabelText = parentGroup
          ? (parentGroup.querySelector('.gpo-label .label-content')?.textContent || '').toLowerCase()
          : '';
        const isWaterproofBoxesGroup = groupLabelText.includes('waterproof boxes');

        // ðŸ”¹ If this is a Waterproof Box, mirror its state to the other box
        if (isWaterproofBoxesGroup && parentGroup) {
          const pairInputs = parentGroup.querySelectorAll('input[gpo-data-variant-id]');
          pairInputs.forEach((inp) => {
            if (inp !== input) {
              inp.checked = input.checked;
              syncCardWithInput(inp);
            }
          });
        }

        console.log(`ðŸ”” Change event on ${variantId}, checked: ${input.checked}`);
        syncCardWithInput(input);
      });


      const ovItem = input.closest('.gpo-ov-item');
      if (ovItem?.parentElement) {
        ovItem.parentElement.insertBefore(card, ovItem);
        processedCards.add(variantId);
        cardsCreated++;
      }

      if (input.checked) {
        card.classList.add('selected');
        console.log(`âœ… Applied .selected to card ${variantId} (checked on load)`);
        
        // Verify it stuck
        setTimeout(() => {
          const checkCard = document.querySelector(`.custom-variant-card[data-variant-id="${variantId}"]`);
          if (checkCard) {
            console.log(`ðŸ” After 500ms, card ${variantId} has selected class:`, checkCard.classList.contains('selected'));
          } else {
            console.log(`âŒ Card ${variantId} no longer exists!`);
          }
        }, 500);
      } else {
        console.log(`âšª Card ${variantId} not checked on load`);
      }
    });

    if (cardsCreated > 0) console.log(`âœ… Created ${cardsCreated} cards`);
  }

  let freebiesStyled = false;
  function styleFreebies(){
    if (freebiesStyled) return;
    const freebiesElement = document.querySelector('.freebies');
    if (!freebiesElement) return;
    freebiesElement.querySelectorAll('.gpo-ov-item').forEach((val) => {
      val.style.background = '#f5f5f5';
      const label = val.querySelector('label');
      if (label) label.style.borderColor = '#000';
    });
    freebiesStyled = true;
  }

  function addAltTextToImages(){
    document.querySelectorAll('.gpo-swatch__image img, .gpo-tooltip__image img, .card-image')
      .forEach((img) => { if (!img.hasAttribute('alt')) img.setAttribute('alt','Product Image'); });
  }

  function initialize(){
    // wait at least once for GPO internals, then build
    let tried = 0, maxTries = 1;
    const t = setInterval(() => {
      tried++;
      const addOns = document.querySelectorAll('.addOn');
      const swatchImages = document.querySelectorAll('.swatch-image');
      if (addOns.length > 0 && swatchImages.length > 0) {
        clearInterval(t);
        buildVariantCards(); styleFreebies(); addAltTextToImages();
      } else if (tried >= maxTries) {
        clearInterval(t);
        buildVariantCards(); styleFreebies(); addAltTextToImages();
      }
    }, 100);
  }

  let mutationTimeout;
  function handleMutations(){
    clearTimeout(mutationTimeout);
    mutationTimeout = setTimeout(() => {
      buildVariantCards(); styleFreebies(); addAltTextToImages();
    }, 150);
  }

  document.addEventListener('DOMContentLoaded', function(){
    initialize();
    const observer = new MutationObserver((mutations) => {
      let shouldUpdate = false;
      for (const m of mutations){
        for (const n of m.addedNodes){
          if (n.nodeType === 1){
            if (n.classList?.contains('gpo-swatches') ||
                n.querySelector?.('.gpo-swatches') ||
                n.classList?.contains('addOn') ||
                n.querySelector?.('.swatch-image')) { shouldUpdate = true; break; }
          }
        }
        if (shouldUpdate) break;
      }
      if (shouldUpdate) handleMutations();
    });
    const gpoContainer = document.querySelector('.gpo-element') || document.body;
    observer.observe(gpoContainer, { childList:true, subtree:true });
  });
</script>

<script>
  /* === Full-width groups + Tier headers/badges (uses .gpo-ov-helptext) === */
  (function () {
    // TEMP: map "test" â†’ Best Value so you can see it without changing GPO admin
    function tierFrom(text) {
      const t = (text || '').toLowerCase().trim();
      if (t.includes('test'))
        return { key: 'best', header: 'BEST VALUE!', headerClass: 'gpo-help-best', badgeClass: 'gpo-badge-best' };
      if (t.includes('starter'))
        return {
          key: 'starters',
          header: 'FOR STARTERS',
          headerClass: 'gpo-help-starters',
          badgeClass: 'gpo-badge-starters',
        };
      if (t.includes('best'))
        return { key: 'best', header: 'BEST VALUE!', headerClass: 'gpo-help-best', badgeClass: 'gpo-badge-best' };
      if (t.includes('pro'))
        return { key: 'pros', header: 'FOR PROS', headerClass: 'gpo-help-pros', badgeClass: 'gpo-badge-pros' };
      return null;
    }

    function markFullWidth() {
      document.querySelectorAll('.gpo-element.gpo-form__group').forEach((group) => {
        const title = (group.querySelector('.gpo-label .label-content')?.textContent || '').toLowerCase();

        // Mark full-width groups
        group.classList.toggle('fullwidth', title.includes('wood type') || title.includes('heater size'));

        // Mark Wood Type for special styling
        group.classList.toggle('wood-type-group', title.includes('wood type'));
      });
    }

    function buildTierMap(group) {
      const map = new Map();
      group.querySelectorAll('.gpo-swatches.gpo-ov-item').forEach((item) => {
        const input = item.querySelector('input[gpo-data-variant-id]');
        if (!input) return;
        const vid = input.getAttribute('gpo-data-variant-id');

        let key = input.getAttribute('data-tier');
        if (key === null) {
          const helpEl = item.querySelector('.gpo-tooltip__title .gpo-ov-helptext');
          const tier = tierFrom(helpEl ? helpEl.textContent : '');
          key = tier ? tier.key : '';
          input.setAttribute('data-tier', key);
        }
        if (key) {
          if (key === 'starters') map.set(vid, { key, header: 'FOR STARTERS', headerClass: 'gpo-help-starters' });
          if (key === 'best') map.set(vid, { key, header: 'BEST VALUE!', headerClass: 'gpo-help-best' });
          if (key === 'pros') map.set(vid, { key, header: 'FOR PROS', headerClass: 'gpo-help-pros' });
        }
      });
      return map;
    }

    function applyTiers(group) {
      const wrap = group.querySelector('.gpo-ov-wrapper.horizontal');
      if (!wrap) return;

      const tierMap = buildTierMap(group);
      if (!tierMap.size) return;

      const cards = Array.from(wrap.querySelectorAll('.custom-variant-card[data-variant-id]'));
      if (!cards.length) return;

      // Insert a header before EACH card (not just first of each tier)
      cards.forEach((card) => {
        const vid = card.getAttribute('data-variant-id');
        const tier = tierMap.get(vid);
        if (!tier) return;

        // Check if there's already a header directly before this card
        const prev = card.previousElementSibling;
        const hasHeader = prev && prev.classList && prev.classList.contains('gpo-help-header');

        if (!hasHeader) {
          const h = document.createElement('div');
          h.className = `gpo-help-header ${tier.headerClass}`;
          {% comment %} h.textContent = tier.header; {% endcomment %}
          h.innerHTML = `<p>${tier.header}</p>`;
          wrap.insertBefore(h, card);
          console.log(`ðŸ“Œ Added header "${tier.header}" before card ${vid}`);
        }
      });
    }

    function run() {
      markFullWidth();
      document.querySelectorAll('.gpo-element.gpo-form__group').forEach((group) => applyTiers(group));
    }

    const ready = () => {
      run();
      // retry a few times to catch late tooltip internals
      let tries = 0,
        maxTries = 10;
      const int = setInterval(() => {
        run();
        if (++tries >= maxTries) clearInterval(int);
      }, 200);
      const mo = new MutationObserver(() => run());
      mo.observe(document.body, { childList: true, subtree: true });
      setTimeout(() => {
        console.log(
          '[GPO tiers] help spans found:',
          document.querySelectorAll('.gpo-tooltip__title .gpo-ov-helptext').length
        );
      }, 1200);
    };

    document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', ready) : ready();
  })();
  
  // Inject SVG star next to every GPO "FOR PROS" header
  document.querySelectorAll('.gpo-help-header.gpo-help-pros').forEach((header) => {
    if (!header.classList.contains('has-star')) {
      fetch('/snippets/icon-star.liquid')
        .then((response) => response.text())
        .then((svg) => {
          header.insertAdjacentHTML('beforeend', svg);
          header.classList.add('has-star'); // prevent duplicates
        });
    }
  });

  // Inline SVG star (from snippets/icon-star.liquid)
  const starSVG = `
  <svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M5.72213 30L8.18326 18.9051L0 11.4458L10.7794 10.4643L15.001 0L19.2226 10.4622L30 11.4437L21.8167 18.903L24.2799 29.9979L15.001 24.109L5.72213 30Z" fill="#1F8A81"/>
  </svg>`;

  // Add star next to every "FOR PROS" header
  function injectStarsForPros() {
    document.querySelectorAll('.gpo-help-header.gpo-help-pros').forEach((header) => {
      // Avoid duplicates
      if (!header.classList.contains('has-star')) {
        header.insertAdjacentHTML('beforeend', starSVG);
        header.classList.add('has-star');
      }
    });
  }

  // Run immediately
  injectStarsForPros();

  // Run again when GPO updates DOM (important!)
  const observer = new MutationObserver(() => {
    injectStarsForPros();
  });
  observer.observe(document.body, { childList: true, subtree: true });
</script>
