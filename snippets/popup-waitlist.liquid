{%- if product.metafields.custom.enable_waitlist == true -%}
  {%- assign google_script_url = 'https://script.google.com/macros/s/AKfycbxKm4wrTJJ-zT0y_MzH_o1jbnhq9D7esNimqpydwI9GBUnSF0c1TSFzgGSvUPgINBUhzQ/exec' -%}
  {%- assign trigger_id = 'btn-trigger-waitlist' -%}

  <style>
    #popup-waitlist.custom-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }
    #popup-waitlist .custom-popup-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      border-radius: 15px;
      padding: 40px;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    #popup-waitlist .custom-popup-close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      z-index: 10;
    }
    #popup-waitlist .popup-layout {
      display: flex;
      gap: 40px;
    }
    #popup-waitlist .popup-left {
      flex: 1;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #popup-waitlist .popup-right {
      flex: 1.2;
      align-content: center;
    }
    #popup-waitlist .popup-img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 15px;
      object-fit: cover;
      background-color: #fbf2e9;
    }
    #popup-waitlist h3 {
      margin: 10px 0 5px;
      font-size: 20px;
      font-weight: 600;
    }
    #popup-waitlist .popup-price {
      font-size: 18px;
      color: #555;
      margin-bottom: 20px;
    }
    #popup-waitlist h2 {
      margin-bottom: 20px;
      font-family: Poppins, sans-serif;
      font-size: 24px;
      color: #000;
    }
    #popup-waitlist .custom-popup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    #popup-waitlist .custom-popup-full {
      grid-column: span 2;
    }

    /* UNIFORM INPUT STYLING */
    #popup-waitlist input:not([type='checkbox']) {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc !important;
      border-radius: 5px !important;
      height: 48px !important;
      box-sizing: border-box;
    }

    /* Checkbox Styling */
    #popup-waitlist .checkbox-wrapper {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: left;
      gap: 12px;
      margin-top: 20px;
      text-align: justify;
    }
    #popup-waitlist .checkbox-wrapper input[type='checkbox'] {
      width: 16px !important;
      height: 16px !important;
      margin: 4px 0 0 0 !important;
      flex-shrink: 0;
      cursor: pointer;
    }
    #popup-waitlist .checkbox-wrapper label {
      font-size: 14px;
      line-height: 1.4;
      cursor: pointer;
      margin: 0;
    }

    /* Submit button styling */
    #popup-waitlist #btn-submit-waitlist {
      width: 100%;
      padding: 15px;
      background: #222120 !important;
      color: #fff !important;
      border: none;
      border-radius: 100px;
      cursor: pointer;
      font-size: 18px;
      margin-top: 20px;
      display: block;
    }

    #popup-waitlist #btn-submit-waitlist:hover {
      background: #444 !important;
    }

    #popup-waitlist .status-msg {
      margin-top: 15px;
      text-align: center;
      display: none;
    }
    .status-success {
      color: green;
    }
    .status-error {
      color: red;
    }

    /* Deposit disclaimer */
    #popup-waitlist .deposit-disclaimer {
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    #popup-waitlist .deposit-disclaimer a {
      text-decoration: underline;
      color: #000;
    }

    @media (max-width: 768px) {
      #popup-waitlist .popup-layout {
        flex-direction: column;
        gap: 10px;
      }
      #popup-waitlist .popup-left {
        display: flex;
        gap: 15px;
        text-align: left;
        align-items: center;
        flex-direction: row;
      }
      #popup-waitlist .popup-img {
        width: 80px;
        height: 80px;
        margin-bottom: 0;
      }
      #popup-waitlist .custom-popup-grid {
        grid-template-columns: 1fr;
      }
      #popup-waitlist .custom-popup-full {
        grid-column: span 1;
      }
      .title_subheading {
        display: flex;
        flex-direction: column;
      }

      #popup-waitlist h3 {
        font-size: 16px;
        margin: 0px 0px 5px;
      }

      #popup-waitlist .popup-price {
        font-size: 14px;
        margin-bottom: 0px;
      }
    }
  </style>

  <div id="popup-waitlist" class="custom-popup-overlay">
    <div class="custom-popup-content">
      <span id="close-waitlist" class="custom-popup-close">&times;</span>
      <div class="popup-layout">
        <div class="popup-left">
          {% if product.featured_media -%}
            <img class="popup-img" src="{{ product.featured_media | img_url: '500x' }}" alt="{{ product.title }}">
          {%- endif %}
          <div class="title_subheading">
            <h3>{{ product.title }}</h3>
            <div class="popup-price">{{ product.price | money }}</div>
          </div>
        </div>

        <div class="popup-right">
          <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 5px;">
              Join our waitlist and get notified early<span style="color: #e74c3c;">*</span>
            </h2>
          </div>
          <form id="form-waitlist">
            <input type="hidden" name="form_type" value="Waitlist">
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <input type="hidden" name="product_title" value="{{ product.title }}">
            <div style="display:none;"><input type="text" name="bot_check" autocomplete="off"></div>

            <div class="custom-popup-grid">
              <div class="custom-popup-full">
                <label>Full Name</label>
                <input type="text" name="full_name" required>
              </div>
              <div class="custom-popup-full">
                <label>Email</label>
                <input type="email" name="email" required>
              </div>
            </div>

            <div class="checkbox-wrapper">
              <label for="waitlist-disclaimer">
                <span style="color: #e74c3c;">*</span>Adding a product to your waitlist will not reserve this product
                for you, you will only be notified when the product is back in stock. To reserve this product, select
                pre-order instead.
              </label>
            </div>

            <button type="submit" id="btn-submit-waitlist">Join Waitlist</button>
            <div id="status-waitlist" class="status-msg"></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const popup = document.getElementById('popup-waitlist');
      const trigger = document.getElementById('{{ trigger_id }}');
      const close = document.getElementById('close-waitlist');
      const form = document.getElementById('form-waitlist');
      const status = document.getElementById('status-waitlist');
      const btn = document.getElementById('btn-submit-waitlist');
      const scriptURL = '{{ google_script_url }}';

      // Function to sync popup price with main price
      function syncPopupPrice() {
        const mainPriceElement = document.querySelector('.product-info__price .price__current');
        const popupPriceElement = document.querySelector('#popup-waitlist .popup-price');

        if (mainPriceElement && popupPriceElement) {
          const updatedPrice = mainPriceElement.textContent.trim();
          popupPriceElement.textContent = updatedPrice;
        }
      }

      // Observe main price changes
      const mainPriceElement = document.querySelector('.product-info__price .price__current');
      if (mainPriceElement) {
        const priceObserver = new MutationObserver(() => {
          syncPopupPrice();
        });

        priceObserver.observe(mainPriceElement, {
          characterData: true,
          childList: true,
          subtree: true,
        });
      }

      if (trigger) {
        trigger.addEventListener('click', (e) => {
          e.preventDefault();
          popup.style.display = 'block';

          // Sync price when popup opens
          syncPopupPrice();
        });
      }

      if (close) {
        close.addEventListener('click', () => {
          popup.style.display = 'none';
        });
      }

      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          popup.style.display = 'none';
        }
      });

      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();

          btn.disabled = true;
          btn.innerText = 'Sending...';

          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());

          let selectedOptions = [];
          document.querySelectorAll('[name^="properties"]').forEach((input) => {
            if ((input.type === 'radio' || input.type === 'checkbox') && !input.checked) return;
            if (!input.value || input.value.trim() === '' || input.name.includes('_has_gpo')) return;
            let label = input.name.replace('properties[', '').replace(']', '').replace('][', ' - ');
            selectedOptions.push(`${label}: ${input.value}`);
          });
          data['custom_options'] = selectedOptions.length > 0 ? selectedOptions.join('\n') : 'No options selected';

          const mainVariantInput = document.querySelector('form[action*="/cart/add"] [name="id"]');
          data['variant_id'] = mainVariantInput
            ? mainVariantInput.value
            : '{{ product.selected_or_first_available_variant.id }}';

          // Get total price
          let totalPrice = null;
          const priceElement = document.querySelector('.product-info__price .price__current');

          if (priceElement) {
            const priceText = priceElement.textContent || priceElement.innerText;
            const priceValue = priceText.replace(/[^0-9.]/g, '');

            if (priceValue && parseFloat(priceValue) > 0) {
              totalPrice = parseFloat(priceValue).toFixed(2);
            }
          }

          if (!totalPrice || parseFloat(totalPrice) <= 0) {
            totalPrice = '{{ product.selected_or_first_available_variant.price | divided_by: 100.0 }}';
          }

          data['total_price'] = totalPrice;

          fetch(scriptURL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data),
          })
            .then(() => {
              status.innerText = 'Success! You have been added to the waitlist.';
              status.className = 'status-msg status-success';
              status.style.display = 'block';
              form.reset();
              setTimeout(() => {
                popup.style.display = 'none';
                status.style.display = 'none';
              }, 3000);
            })
            .catch((err) => {
              status.innerText = 'Error. Please try again.';
              status.className = 'status-msg status-error';
              status.style.display = 'block';
            })
            .finally(() => {
              btn.disabled = false;
              btn.innerText = 'Join Waitlist';
            });
        });
      }
    });
  </script>
{%- endif -%}
